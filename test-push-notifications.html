<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        .support-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        .support-item { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçû HomeBake Push Notification Test</h1>
        <p>This page tests the enhanced push notification detection for mobile browsers.</p>
        
        <div id="status" class="status info">Checking browser support...</div>
        
        <div class="support-grid">
            <div class="support-item">
                <strong>Service Worker:</strong> <span id="sw-support">‚ùì</span>
            </div>
            <div class="support-item">
                <strong>Push Manager:</strong> <span id="pm-support">‚ùì</span>
            </div>
            <div class="support-item">
                <strong>Notifications:</strong> <span id="notif-support">‚ùì</span>
            </div>
            <div class="support-item">
                <strong>iOS Safari:</strong> <span id="ios-safari">‚ùì</span>
            </div>
            <div class="support-item">
                <strong>iOS Version:</strong> <span id="ios-version">‚ùì</span>
            </div>
            <div class="support-item">
                <strong>Support Level:</strong> <span id="support-level">‚ùì</span>
            </div>
        </div>
        
        <div id="recommendations" style="display: none;">
            <h3>Recommended Browsers:</h3>
            <ul id="browser-list"></ul>
        </div>
        
        <div>
            <button onclick="testPermission()">Test Permission Request</button>
            <button onclick="testServiceWorker()">Test Service Worker</button>
            <button onclick="showDetails()">Show Details</button>
        </div>
        
        <div id="details" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h3>Technical Details:</h3>
            <pre id="tech-details"></pre>
        </div>
    </div>

    <script>
        // Browser detection logic (matching the enhanced implementation)
        function checkBrowserSupport() {
            const userAgent = navigator.userAgent;
            
            // Basic feature detection
            const hasServiceWorker = 'serviceWorker' in navigator;
            const hasPushManager = 'PushManager' in window;
            const hasNotifications = 'Notification' in window;
            
            // Browser detection
            const isIOSSafari = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
            const isMobileSafari = /Safari/.test(userAgent) && /Mobile/.test(userAgent) && !/Chrome/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
            const isFirefox = /Firefox/.test(userAgent);
            
            // iOS version detection for Safari
            let isIOSVersionSupported = true;
            let iosVersionString = 'N/A';
            if (isIOSSafari) {
                const match = userAgent.match(/OS (\d+)_(\d+)/);
                if (match) {
                    const majorVersion = parseInt(match[1]);
                    const minorVersion = parseInt(match[2]);
                    iosVersionString = `${majorVersion}.${minorVersion}`;
                    // iOS 16.4+ required for web push
                    isIOSVersionSupported = majorVersion > 16 || (majorVersion === 16 && minorVersion >= 4);
                } else {
                    isIOSVersionSupported = false;
                    iosVersionString = 'Unknown (likely old)';
                }
            }
            
            // Determine support level
            let supportLevel = 'none';
            let reason = '';
            let recommendedBrowsers = [];
            
            if (!hasServiceWorker || !hasPushManager || !hasNotifications) {
                supportLevel = 'none';
                reason = 'Browser lacks essential web push APIs';
                recommendedBrowsers = ['Chrome', 'Firefox', 'Safari 16.4+'];
            } else if (isIOSSafari && !isIOSVersionSupported) {
                supportLevel = 'none';
                reason = 'iOS Safari requires version 16.4 or later for web push notifications';
                recommendedBrowsers = ['Update to iOS 16.4+', 'Chrome for iOS', 'Firefox for iOS'];
            } else if (isMobileSafari && !isIOSSafari) {
                supportLevel = 'partial';
                reason = 'Mobile Safari has limited push notification support';
                recommendedBrowsers = ['Chrome for Android', 'Firefox for Android'];
            } else if (isChrome || isFirefox || (isIOSSafari && isIOSVersionSupported)) {
                supportLevel = 'full';
                reason = 'Push notifications are fully supported';
                recommendedBrowsers = [];
            } else {
                supportLevel = 'partial';
                reason = 'Browser may have limited push notification support';
                recommendedBrowsers = ['Chrome', 'Firefox', 'Safari 16.4+'];
            }
            
            return {
                hasServiceWorker,
                hasPushManager,
                hasNotifications,
                isIOSSafari,
                isMobileSafari,
                isChrome,
                isFirefox,
                isIOSVersionSupported,
                iosVersionString,
                supportLevel,
                reason,
                recommendedBrowsers,
                userAgent
            };
        }
        
        function updateUI() {
            const support = checkBrowserSupport();
            
            // Update status
            const statusEl = document.getElementById('status');
            if (support.supportLevel === 'full') {
                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ ' + support.reason;
            } else if (support.supportLevel === 'partial') {
                statusEl.className = 'status warning';
                statusEl.textContent = '‚ö†Ô∏è ' + support.reason;
            } else {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå ' + support.reason;
            }
            
            // Update support grid
            document.getElementById('sw-support').textContent = support.hasServiceWorker ? '‚úÖ' : '‚ùå';
            document.getElementById('pm-support').textContent = support.hasPushManager ? '‚úÖ' : '‚ùå';
            document.getElementById('notif-support').textContent = support.hasNotifications ? '‚úÖ' : '‚ùå';
            document.getElementById('ios-safari').textContent = support.isIOSSafari ? 'Yes' : 'No';
            document.getElementById('ios-version').textContent = support.iosVersionString;
            document.getElementById('support-level').textContent = support.supportLevel.toUpperCase();
            
            // Show recommendations if needed
            if (support.recommendedBrowsers.length > 0) {
                const recommendationsEl = document.getElementById('recommendations');
                const browserListEl = document.getElementById('browser-list');
                
                browserListEl.innerHTML = '';
                support.recommendedBrowsers.forEach(browser => {
                    const li = document.createElement('li');
                    li.textContent = browser;
                    browserListEl.appendChild(li);
                });
                
                recommendationsEl.style.display = 'block';
            }
            
            // Store support data for details
            window.supportData = support;
        }
        
        async function testPermission() {
            try {
                if (!('Notification' in window)) {
                    alert('‚ùå Notifications are not supported in this browser');
                    return;
                }
                
                const permission = await Notification.requestPermission();
                let message = '';
                
                switch (permission) {
                    case 'granted':
                        message = '‚úÖ Permission granted! Notifications will work.';
                        // Show a test notification
                        new Notification('üçû HomeBake Test', {
                            body: 'Push notifications are working!',
                            icon: '/favicon.ico'
                        });
                        break;
                    case 'denied':
                        message = '‚ùå Permission denied. Please enable notifications in browser settings.';
                        break;
                    case 'default':
                        message = '‚ö†Ô∏è Permission not determined. User dismissed the prompt.';
                        break;
                }
                
                alert(message);
            } catch (error) {
                alert('‚ùå Error requesting permission: ' + error.message);
            }
        }
        
        async function testServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                alert('‚ùå Service Worker not supported');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                alert('‚úÖ Service Worker registered successfully');
                console.log('Service Worker registration:', registration);
            } catch (error) {
                alert('‚ùå Service Worker registration failed: ' + error.message);
                console.error('Service Worker error:', error);
            }
        }
        
        function showDetails() {
            const detailsEl = document.getElementById('details');
            const techDetailsEl = document.getElementById('tech-details');
            
            if (detailsEl.style.display === 'none') {
                techDetailsEl.textContent = JSON.stringify(window.supportData, null, 2);
                detailsEl.style.display = 'block';
            } else {
                detailsEl.style.display = 'none';
            }
        }
        
        // Initialize on page load
        updateUI();
    </script>
</body>
</html>